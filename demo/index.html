<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://timur00kh.github.io/whisper.wasm/" />
    <meta property="og:title" content="Whisper.wasm Demo - Speech Recognition in Browser" />
    <meta
      property="og:description"
      content="Whisper.wasm Demo - Speech recognition directly in the browser using WebAssembly"
    />
    <meta property="og:image" content="https://timur00kh.github.io/whisper.wasm/image.png" />
    <meta property="og:site_name" content="Whisper.wasm" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://whisper.wasm/" />
    <meta property="twitter:title" content="Whisper.wasm Demo - Speech Recognition in Browser" />
    <meta
      property="twitter:description"
      content="Whisper.wasm Demo - Speech recognition directly in the browser using WebAssembly"
    />
    <meta property="twitter:image" content="https://timur00kh.github.io/whisper.wasm/image.png" />

    <!-- Basic Meta Tags -->
    <title>Whisper.wasm Demo - Speech Recognition in Browser</title>
    <meta
      name="description"
      content="Whisper.wasm Demo - Speech recognition directly in the browser using WebAssembly"
    />
    <meta
      name="keywords"
      content="whisper, speech recognition, webassembly, wasm, transcription, audio"
    />
    <meta name="author" content="Whisper.wasm" />

    <script src="./coi-serviceworker.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="module">
      import { h, render } from 'preact';
      import { useState, useMemo, useEffect } from 'preact/hooks';
      import htm from 'htm';
      import { WhisperWasmService } from '../src/index.ts';
      import { ModelManager } from '../src/index.ts';
      import { getAllModels } from '../src/index.ts';
      import { AudioHandler } from './audioHandler.js';

      const html = htm.bind(h);

      function App() {
        const [wasmSupported, setWasmSupported] = useState(null);
        const [availableModels, setAvailableModels] = useState([]);
        const [selectedModel, setSelectedModel] = useState('base');
        const [modelLoaded, setModelLoaded] = useState(false);
        const [audioFile, setAudioFile] = useState(null);
        const [transcription, setTranscription] = useState('');
        const [status, setStatus] = useState('');
        const [loading, setLoading] = useState(false);
        const [progress, setProgress] = useState(0);
        const [canCancel, setCanCancel] = useState(false);
        const [abortController, setAbortController] = useState(null);

        const whisperService = useMemo(() => new WhisperWasmService({ logLevel: 0 }), []);
        const modelManager = useMemo(() => new ModelManager(), []);
        const audioHandler = useMemo(() => new AudioHandler(), []);

        const loadAvailableModels = async () => {
          try {
            const models = await modelManager.getAvailableModels();
            setAvailableModels(models);
          } catch (error) {
            console.error('Error loading models:', error);
            // Fallback to sync version
            setAvailableModels(getAllModels());
            setStatus('Error loading cache information');
          }
        };

        // Load models on initialization
        useEffect(() => {
          loadAvailableModels();
          window.modelManager = modelManager;
          window.whisperService = whisperService;
        }, []);

        const checkWasmSupport = async () => {
          try {
            const supported = await whisperService.checkWasmSupport();
            setWasmSupported(supported);
            setStatus(supported ? 'WASM is supported' : 'WASM is not supported');
          } catch (error) {
            setStatus(`Error: ${error.message}`);
          }
        };

        useEffect(() => {
          checkWasmSupport();
        }, []);

        const loadModel = async () => {
          setLoading(true);
          setProgress(0);
          setStatus('Loading model...');
          console.log('Loading model:', selectedModel);
          try {
            const modelData = await modelManager.loadModel(selectedModel, true, (progress) => {
              setProgress(progress);
              setStatus(`Loading model... ${progress}%`);
            });
            console.log('Model data loaded, size:', modelData.length);
            // await whisperService.loadWasmScriptUnsafe();
            await whisperService.initModel(modelData);
            console.log('WASM module loaded successfully');
            setModelLoaded(true);
            setStatus(`Model ${selectedModel} loaded successfully!`);

            // Reset cancel state when loading new model
            setCanCancel(false);
            setAbortController(null);

            // Update model list after loading
            await loadAvailableModels();
          } catch (error) {
            console.error('Error loading model:', error);
            setStatus(`Error loading model: ${error.message}`);
          } finally {
            setLoading(false);
            loadAvailableModels();
          }
        };

        const handleFileSelect = (event) => {
          const file = event.target.files[0];
          if (file) {
            setAudioFile(file);
            setStatus(`File ${file.name} selected (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            // Reset cancel state when selecting new file
            setCanCancel(false);
            setAbortController(null);
          }
        };

        const msToTime = (ms) => {
          const totalSeconds = Math.floor(ms / 1000);
          const hours = Math.floor(totalSeconds / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;

          return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        };

        const cancelTranscription = () => {
          if (abortController) {
            abortController.abort();
            setCanCancel(false);
            setLoading(false);
            setStatus('Transcription cancelled');
            setAbortController(null);
          }
        };

        const transcribeAudio = async () => {
          if (!modelLoaded || !audioFile) {
            setStatus('Please load a model and select an audio file first');
            return;
          }

          // Create new AbortController for this transcription
          const controller = new AbortController();
          setAbortController(controller);
          setCanCancel(true);
          setLoading(true);
          setStatus('Transcription in progress...');
          setTranscription(''); // Clear previous result

          try {
            await audioHandler.loadAudio(
              audioFile,
              // onProgress
              (message) => {
                if (controller.signal.aborted) return;
                setStatus(message);
              },
              // onSuccess
              async (audioData, audioInfo) => {
                if (controller.signal.aborted) return;

                console.log('Audio processed:', audioInfo);
                try {
                  const session = whisperService.createSession();
                  const result = await session.streamimg(audioData, {
                    language: 'ru',
                    threads: 25,
                    translate: false,
                  });

                  for await (const segment of result) {
                    if (controller.signal.aborted) {
                      throw new Error('Transcription cancelled');
                    }
                    setTranscription(
                      (t) =>
                        t +
                        `[${msToTime(segment.timeStart)} --> ${msToTime(segment.timeEnd)}]: ${segment.text}` +
                        '\n',
                    );
                  }

                  if (!controller.signal.aborted) {
                    setStatus('Transcription completed!');
                  }
                } catch (error) {
                  if (error.message === 'Transcription cancelled') {
                    setStatus('Transcription cancelled');
                  } else {
                    console.error('Transcription error:', error);
                    setStatus(`Transcription error: ${error.message}`);
                  }
                }
                setLoading(false);
                setCanCancel(false);
                setAbortController(null);
              },
              // onError
              (error) => {
                if (controller.signal.aborted) return;

                console.error('Audio processing error:', error);
                setStatus(`Audio processing error: ${error}`);
                setLoading(false);
                setCanCancel(false);
                setAbortController(null);
              },
            );
          } catch (error) {
            if (error.name === 'AbortError') {
              setStatus('Transcription cancelled');
            } else {
              console.error('Transcription error:', error);
              setStatus(`Transcription error: ${error.message}`);
            }
            setLoading(false);
            setCanCancel(false);
            setAbortController(null);
          }
        };

        return html`
          <div
            style="max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;"
          >
            <h1>Whisper.wasm Demo</h1>

            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
              <h2>1. Check WASM Support</h2>
              <button onClick=${checkWasmSupport} disabled=${loading}>Check WASM Support</button>
              ${wasmSupported !== null &&
              html`
                <div
                  style="margin-top: 10px; padding: 10px; background-color: ${wasmSupported
                    ? '#d4edda'
                    : '#f8d7da'}; color: ${wasmSupported
                    ? '#155724'
                    : '#721c24'}; border-radius: 3px;"
                >
                  WASM ${wasmSupported ? 'is supported' : 'is not supported'}
                </div>
              `}
            </div>

            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
              <h2>2. Load Model</h2>
              <div style="margin-bottom: 10px;">
                <select
                  value=${selectedModel}
                  onChange=${(e) => setSelectedModel(e.target.value)}
                  style="margin-right: 10px;"
                >
                  ${availableModels.map(
                    (model) => html`
                      <option value=${model.id}>
                        ${model.cached ? '✅' : '⬇️'} ${model.name} (${model.size}MB) -
                        ${model.language === 'en' ? 'English' : 'Multilingual'}${model.quantized
                          ? ' [Quantized]'
                          : ''}
                      </option>
                    `,
                  )}
                </select>
              </div>
              <button onClick=${loadModel} disabled=${loading || !wasmSupported}>Load Model</button>
              <button
                onClick=${async () => {
                  try {
                    await modelManager.clearCache();
                    await loadAvailableModels();
                    setStatus('Cache cleared');
                  } catch (error) {
                    setStatus(`Error clearing cache: ${error.message}`);
                  }
                }}
                style="margin-left: 10px;"
                disabled=${loading}
              >
                🗑️ Clear Cache
              </button>
              ${loading &&
              progress > 0 &&
              html`
                <div style="margin-top: 10px;">
                  <div
                    style="width: 100%; background-color: #f0f0f0; border-radius: 10px; overflow: hidden;"
                  >
                    <div
                      style="
                        width: ${progress}%; 
                        height: 20px; 
                        background-color: #4CAF50; 
                        transition: width 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 12px;
                        font-weight: bold;
                      "
                    >
                      ${progress}%
                    </div>
                  </div>
                </div>
              `}
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                ✅ = cached, ⬇️ = needs download
              </div>
              ${modelLoaded &&
              html`
                <div
                  style="margin-top: 10px; padding: 10px; background-color: #d4edda; color: #155724; border-radius: 3px;"
                >
                  Model loaded!
                </div>
              `}
            </div>

            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
              <h2>3. Load Audio</h2>
              <input
                type="file"
                accept="audio/*"
                onChange=${handleFileSelect}
                style="margin-bottom: 10px;"
              />
              ${audioFile &&
              html`
                <div
                  style="padding: 10px; background-color: #d4edda; color: #155724; border-radius: 3px;"
                >
                  File: ${audioFile.name} (${(audioFile.size / 1024 / 1024).toFixed(2)} MB)
                </div>
              `}
            </div>

            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
              <h2>4. Transcription</h2>
              <div style="margin-bottom: 10px;">
                <button
                  onClick=${transcribeAudio}
                  disabled=${loading || !modelLoaded || !audioFile}
                >
                  ${loading ? 'Processing...' : 'Transcribe'}
                </button>
                ${canCancel &&
                html`
                  <button onClick=${cancelTranscription} style="margin-left: 10px;">
                    ❌ Cancel
                  </button>
                `}
              </div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Debug: modelLoaded=${modelLoaded}, audioFile=${!!audioFile}, loading=${loading},
                canCancel=${canCancel}
              </div>
              ${transcription &&
              html`
                <div style="margin-top: 10px;">
                  <h3>Result:</h3>
                  <textarea
                    value=${transcription}
                    readonly
                    style="width: 100%; height: 100px; margin-top: 10px;"
                  />
                </div>
              `}
            </div>

            ${status &&
            html`
              <div
                style="margin: 20px 0; padding: 10px; background-color: #d1ecf1; color: #0c5460; border-radius: 3px;"
              >
                ${status}
              </div>
            `}
          </div>
        `;
      }

      render(html`<${App} />`, document.getElementById('root'));
    </script>
  </body>
</html>
