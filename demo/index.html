<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://timur00kh.github.io/whisper.wasm/">
    <meta property="og:title" content="Whisper.wasm Demo - Speech Recognition in Browser">
    <meta property="og:description" content="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã Whisper.wasm - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º WebAssembly">
    <meta property="og:image" content="https://timur00kh.github.io/whisper.wasm/image.png">
    <meta property="og:site_name" content="Whisper.wasm">
    <meta property="og:locale" content="ru_RU">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://whisper.wasm/">
    <meta property="twitter:title" content="Whisper.wasm Demo - Speech Recognition in Browser">
    <meta property="twitter:description" content="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã Whisper.wasm - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º WebAssembly">
    <meta property="twitter:image" content="https://timur00kh.github.io/whisper.wasm/image.png">
    
    <!-- Basic Meta Tags -->
    <title>Whisper.wasm Demo - Speech Recognition in Browser</title>
    <meta name="description" content="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã Whisper.wasm - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º WebAssembly">
    <meta name="keywords" content="whisper, speech recognition, webassembly, wasm, transcription, audio">
    <meta name="author" content="Whisper.wasm">
    
    <script src="./coi-serviceworker.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="module">
      import { h, render } from "preact";
      import { useState, useMemo, useEffect } from 'preact/hooks';
      import htm from 'htm';
      import { WhisperWasmService } from '../dist/index.es.js';
      import { ModelManager } from '../dist/index.es.js';
      import { getAllModels } from '../dist/index.es.js';
      import { AudioHandler } from './audioHandler.js';
      
      const html = htm.bind(h);

      function App() {
        const [wasmSupported, setWasmSupported] = useState(null);
        const [availableModels, setAvailableModels] = useState([]);
        const [selectedModel, setSelectedModel] = useState('base');
        const [modelLoaded, setModelLoaded] = useState(false);
        const [audioFile, setAudioFile] = useState(null);
        const [transcription, setTranscription] = useState('');
        const [status, setStatus] = useState('');
        const [loading, setLoading] = useState(false);
        const [progress, setProgress] = useState(0);

        const whisperService = useMemo(() => new WhisperWasmService({ logLevel: 0 }), []);
        const modelManager = useMemo(() => new ModelManager(), []);
        const audioHandler = useMemo(() => new AudioHandler(), []);

        const loadAvailableModels = async () => {
          try {
            const models = await modelManager.getAvailableModels();
            setAvailableModels(models);
          } catch (error) {
            console.error('Error loading models:', error);
            // Fallback to sync version
            setAvailableModels(getAllModels());
            setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—ç—à–µ');
          }
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        useEffect(() => {
          loadAvailableModels();
          window.modelManager = modelManager;

        }, []);

        const checkWasmSupport = async () => {
          try {
            const supported = await whisperService.checkWasmSupport();
            setWasmSupported(supported);
            setStatus(supported ? 'WASM –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : 'WASM –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
          } catch (error) {
            setStatus(`–û—à–∏–±–∫–∞: ${error.message}`);
          }
        };

        useEffect(() => {
          checkWasmSupport();
        }, []);

        const loadModel = async () => {
          setLoading(true);
          setProgress(0);
          setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...');
          console.log('Loading model:', selectedModel);
          try {
            const modelData = await modelManager.loadModel(
              selectedModel, 
              true, 
              (progress) => {
                setProgress(progress);
                setStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏... ${progress}%`);
              }
            );
            console.log('Model data loaded, size:', modelData.length);
            // await whisperService.loadWasmScriptUnsafe();
            await whisperService.loadWasmModule(modelData);
            console.log('WASM module loaded successfully');
            setModelLoaded(true);
            setStatus(`–ú–æ–¥–µ–ª—å ${selectedModel} –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            await loadAvailableModels();
          } catch (error) {
            console.error('Error loading model:', error);
            setStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: ${error.message}`);
          } finally {
            setLoading(false);
            loadAvailableModels();
          }
        };

        const handleFileSelect = (event) => {
          const file = event.target.files[0];
          if (file) {
            setAudioFile(file);
            setStatus(`–§–∞–π–ª ${file.name} –≤—ã–±—Ä–∞–Ω (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
          }
        };

        const transcribeAudio = async () => {
          if (!modelLoaded || !audioFile) {
            setStatus('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª');
            return;
          }

          setLoading(true);
          setStatus('–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');
          
          await audioHandler.loadAudio(
            audioFile,
            // onProgress
            (message) => {
              setStatus(message);
            },
            // onSuccess
            async (audioData, audioInfo) => {
              console.log('Audio processed:', audioInfo);
              try {
                const result = await whisperService.transcribe(
                  audioData, 
                  (e) => setTranscription((t) => t + e.raw + '\n'), 
                  { language: 'ru', threads: 25, translate: false }
                );
                if (transcription) setTranscription(t + '\n\n');
                setTranscription((t) => t + '\n\n' + result.transcribeDurationMs + 'Ms');
                setStatus('–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
              } catch (error) {
                console.error('Transcription error:', error);
                setStatus(`–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏: ${error.message}`);
              }
              setLoading(false);
            },
            // onError
            (error) => {
              console.error('Audio processing error:', error);
              setStatus(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ: ${error}`);
              setLoading(false);
            }
          );
        };

        return html`
          <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
            <h1>Whisper.wasm Demo</h1>
            
            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
              <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WASM</h2>
              <button onClick=${checkWasmSupport} disabled=${loading}>
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É WASM
              </button>
              ${wasmSupported !== null && html`
                <div style="margin-top: 10px; padding: 10px; background-color: ${wasmSupported ? '#d4edda' : '#f8d7da'}; color: ${wasmSupported ? '#155724' : '#721c24'}; border-radius: 3px;">
                  WASM ${wasmSupported ? '–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'}
                </div>
              `}
            </div>

            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
              <h2>2. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏</h2>
              <div style="margin-bottom: 10px;">
                <select value=${selectedModel} onChange=${(e) => setSelectedModel(e.target.value)} style="margin-right: 10px;">
                  ${availableModels.map(model => html`
                    <option value=${model.id}>
                      ${model.cached ? '‚úÖ' : '‚¨áÔ∏è'} ${model.name} (${model.size}MB) - ${model.language === 'en' ? 'English' : 'Multilingual'}${model.quantized ? ' [Quantized]' : ''}
                    </option>
                  `)}
                </select>
              </div>
              <button onClick=${loadModel} disabled=${loading || !wasmSupported}>
                –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å
              </button>
              <button onClick=${async () => {
                try {
                  await modelManager.clearCache();
                  await loadAvailableModels();
                  setStatus('–ö—ç—à –æ—á–∏—â–µ–Ω');
                } catch (error) {
                  setStatus(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞: ${error.message}`);
                }
              }} style="margin-left: 10px;" disabled=${loading}>
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
              </button>
              ${loading && progress > 0 && html`
                <div style="margin-top: 10px;">
                  <div style="width: 100%; background-color: #f0f0f0; border-radius: 10px; overflow: hidden;">
                    <div 
                      style="
                        width: ${progress}%; 
                        height: 20px; 
                        background-color: #4CAF50; 
                        transition: width 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 12px;
                        font-weight: bold;
                      "
                    >
                      ${progress}%
                    </div>
                  </div>
                </div>
              `}
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                ‚úÖ = –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ, ‚¨áÔ∏è = –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å
              </div>
              ${modelLoaded && html`
                <div style="margin-top: 10px; padding: 10px; background-color: #d4edda; color: #155724; border-radius: 3px;">
                  –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!
                </div>
              `}
            </div>

            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
              <h2>3. –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ</h2>
              <input type="file" accept="*/*" onChange=${handleFileSelect} style="margin-bottom: 10px;" />
              ${audioFile && html`
                <div style="padding: 10px; background-color: #d4edda; color: #155724; border-radius: 3px;">
                  –§–∞–π–ª: ${audioFile.name} (${(audioFile.size / 1024 / 1024).toFixed(2)} MB)
                </div>
              `}
            </div>

            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
              <h2>4. –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</h2>
              <button onClick=${transcribeAudio} disabled=${loading || !modelLoaded || !audioFile}>
                ${loading ? '–û–±—Ä–∞–±–æ—Ç–∫–∞...' : '–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å'}
              </button>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Debug: modelLoaded=${modelLoaded}, audioFile=${!!audioFile}, loading=${loading}
              </div>
              ${transcription && html`
                <div style="margin-top: 10px;">
                  <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
                  <textarea 
                    value=${transcription} 
                    readonly 
                    style="width: 100%; height: 100px; margin-top: 10px;"
                  />
                </div>
              `}
            </div>

            ${status && html`
              <div style="margin: 20px 0; padding: 10px; background-color: #d1ecf1; color: #0c5460; border-radius: 3px;">
                ${status}
              </div>
            `}
          </div>
        `;
      }

      render(html`<${App}/>`, document.getElementById('root'));
    </script>
  </body>
</html>
